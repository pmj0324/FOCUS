# β… Flow Matching Parameter Inference & Likelihood Contour μ‹μ¤ν… μ™„μ„±!

## π― μ™„μ„±λ κΈ°λ¥

### 1. **Parameter Inference** (νλΌλ―Έν„° μ¶”μ •)
- β… Flow Matching λ¨λΈμ likelihood κ³„μ‚°
- β… MLE (Maximum Likelihood Estimation)
- β… MCMC (Markov Chain Monte Carlo) μƒν”λ§
- β… Grid Search

### 2. **Likelihood Contour** (μƒλ΅ μ¶”κ°€!) π†•
- β… 2D νλΌλ―Έν„° κ³µκ°„ likelihood contour
- β… Corner plot (μ—¬λ¬ νλΌλ―Έν„° μ)
- β… True value, MLE result, Grid maximum λ™μ‹ ν‘μ‹
- β… κ³ ν•΄μƒλ„ μ‹κ°ν™”

## π“ μƒμ„±λ νμΌ λ©λ΅

### λ©”μΈ μ¤ν¬λ¦½νΈ (3κ°)
```
β”β”€β”€ parameter_inference.py         # νλΌλ―Έν„° μ¶”μ • λ©”μΈ λ¨λ“
β”β”€β”€ run_inference_example.py       # κ°„νΈ μ‹¤ν–‰ μ¤ν¬λ¦½νΈ  
β””β”€β”€ likelihood_contour.py          # Likelihood contour μ‹κ°ν™” π†•
```

### λ¬Έμ„ (5κ°)
```
β”β”€β”€ README_INFERENCE.md            # Parameter inference μ‚¬μ© κ°€μ΄λ“
β”β”€β”€ PARAMETER_INFERENCE_SUMMARY.md # κΈ°μ  λ¬Έμ„
β”β”€β”€ LIKELIHOOD_CONTOUR_README.md   # Contour μ‚¬μ© κ°€μ΄λ“ π†•
β”β”€β”€ μ‘μ—…_μ™„λ£_μ”μ•½.md              # ν•κΈ€ μ”μ•½
β””β”€β”€ β…_μ™„μ„±_μµμΆ…_μ”μ•½.md           # μ΄ νμΌ
```

### κ²°κ³Ό νμΌ (μμ‹)
```
inference_results/
β”β”€β”€ inference_mle_results.png         # MLE κ²°κ³Ό μ‹κ°ν™”
β”β”€β”€ mle_loss_history.png              # Loss history
β”β”€β”€ likelihood_contour_0_1_idx1234.png   # 2D contour π†•
β”β”€β”€ likelihood_contour_0_2_idx1234.png   # 2D contour (with MLE) π†•
β””β”€β”€ likelihood_corner_idx1234.png        # Corner plot π†•
```

## π€ λΉ λ¥Έ μ‹μ‘

### 1. Parameter Inference (MLE)

```bash
cd /home/work/Cosmology/FOCUS/tasks/experiment_flow

# κΈ°λ³Έ μ‹¤ν–‰
python run_inference_example.py

# νΉμ • μƒν”λ΅
python run_inference_example.py --test_idx 1234 --iterations 200

# MCMC
python run_inference_example.py --method mcmc --num_samples 1000
```

**κ²°κ³Ό**: `inference_results/inference_mle_idx{N}.png`

### 2. Likelihood Contour μ‹κ°ν™” π†•

```bash
# 2D contour (Ξ©m vs Ξ©b)
python likelihood_contour.py --test_idx 1234

# λ‹¤λ¥Έ νλΌλ―Έν„° μ (Ξ©m vs h)  
python likelihood_contour.py --test_idx 1234 --param1 0 --param2 2 --grid_points 25

# MLE κ²°κ³Όμ™€ ν•¨κ»
python likelihood_contour.py --test_idx 1234 --run_mle --grid_points 25

# Corner plot (6κ° νλΌλ―Έν„° μ)
python likelihood_contour.py --test_idx 1234 --corner --grid_points 15
```

**κ²°κ³Ό**: `inference_results/likelihood_*.png`

## π¨ μ‹κ°ν™” μμ‹

### Parameter Inference κ²°κ³Ό
```
[κ΄€μΈ΅ λ°μ΄ν„°]  [μƒμ„± μƒν” 1]  [μƒμ„± μƒν” 2]
[μƒμ„± μƒν” 3]  [μƒμ„± μƒν” 4]  [νλΌλ―Έν„° λΉ„κµ]

True:      [0.107, 0.847, 1.038, ...]
Estimated: [0.270, 1.001, 2.146, ...]
```

### Likelihood Contour π†•
```
       Ξ©b
        β†‘
        β”‚  β•±β•²        β† Likelihood peak
        β”‚ β•±  β•²
        β”‚β•± β…  β•²      β…: True value
        β”‚  β–²   β•²     β–²: Grid maximum
        β”‚   β—   β•²    β—: MLE result
        β””β”€β”€β”€β”€β”€β”€β”€β”€β”€β†’ Ξ©m
```

## π’΅ μ£Όμ” μ‚¬μ© μ‚¬λ΅€

### μ‚¬λ΅€ 1: "μ‹¤μ  κ΄€μΈ΅ λ°μ΄ν„°λ΅ νλΌλ―Έν„° μ¶”μ •"

```bash
# 1. MLEλ΅ νλΌλ―Έν„° μ¶”μ •
python run_inference_example.py --test_idx 1234 --iterations 200

# 2. Likelihood landscape ν™•μΈ
python likelihood_contour.py --test_idx 1234 --run_mle --grid_points 30

# 3. Corner plotμΌλ΅ μ „μ²΄ κµ¬μ΅° νμ•…
python likelihood_contour.py --test_idx 1234 --corner --grid_points 20
```

### μ‚¬λ΅€ 2: "νλΌλ―Έν„° degeneracy λ¶„μ„"

```bash
# μ—¬λ¬ νλΌλ―Έν„° μμ contour λΉ„κµ
python likelihood_contour.py --test_idx 1234 --param1 0 --param2 1  # Ξ©m vs Ξ©b
python likelihood_contour.py --test_idx 1234 --param1 0 --param2 2  # Ξ©m vs h
python likelihood_contour.py --test_idx 1234 --param1 3 --param2 4  # ns vs Οƒ8
```

### μ‚¬λ΅€ 3: "MCMC posterior κ²€μ¦"

```bash
# 1. MCMC μ‹¤ν–‰
python run_inference_example.py --test_idx 1234 --method mcmc

# 2. Likelihood contourμ™€ λΉ„κµ
python likelihood_contour.py --test_idx 1234 --corner
```

## π“ μ„±λ¥ λ° μ†μ” μ‹κ°„

| μ‘μ—… | μ„¤μ • | μ‹κ°„ (GPU) |
|------|------|-----------|
| MLE | 200 iterations | ~35μ΄ |
| MLE | 100 iterations | ~18μ΄ |
| 2D Contour | 20Γ—20 grid | ~8λ¶„ |
| 2D Contour | 30Γ—30 grid | ~15λ¶„ |
| Corner Plot | 15Γ—15, 6 pairs | ~18λ¶„ |
| MCMC | 1000 samples | ~10λ¶„ |

## π“ νλΌλ―Έν„° μΈλ±μ¤

| Index | Parameter | ν•κΈ€ μ„¤λ… |
|-------|-----------|----------|
| 0 | Ξ©m | λ¬Όμ§ λ°€λ„ νλΌλ―Έν„° |
| 1 | Ξ©b | μ¤‘μ…μ λ°€λ„ νλΌλ―Έν„° |
| 2 | h | ν—λΈ” νλΌλ―Έν„° |
| 3 | ns | μ¤μΉΌλΌ μ¤ν™νΈλ΄ μΈλ±μ¤ |
| 4 | Οƒ8 | μ”λ™ μ§„ν­ |
| 5 | w | μ•”ν‘μ—λ„μ§€ μƒνƒλ°©μ •μ‹ |

## π’» Python API

### Parameter Inference

```python
from parameter_inference import ParameterInference
import torch

# Initialize
inferencer = ParameterInference(
    checkpoint_path='checkpoints/checkpoint_best.pt',
    config_path='config.yaml',
    device='cuda'
)

# Load data
x_obs = torch.tensor(your_data, device='cuda')  # [1, 1, 256, 256]

# Run MLE
params, losses = inferencer.infer_mle(x_obs, num_iterations=200)
print(f"Estimated: {params}")

# Visualize
inferencer.visualize_results(x_obs, params, save_path='result.png')
```

### Likelihood Contour

```python
from likelihood_contour import (
    compute_likelihood_grid_2d,
    plot_likelihood_contour,
    plot_corner_likelihood
)

# Compute 2D likelihood grid
grid_0, grid_1, likelihoods = compute_likelihood_grid_2d(
    inferencer, x_obs,
    param_idx1=0,  # Ξ©m
    param_idx2=1,  # Ξ©b
    grid_points=30
)

# Plot contour
fig, ax = plot_likelihood_contour(
    grid_0, grid_1, likelihoods,
    param_idx1=0, param_idx2=1,
    inferencer=inferencer,
    true_params=params_true,
    mle_params=params_mle,
    save_path='contour.png'
)

# Corner plot
fig = plot_corner_likelihood(
    inferencer, x_obs,
    grid_points=20,
    save_path='corner.png'
)
```

## π”¬ μ‹¤μ  ν…μ¤νΈ κ²°κ³Ό

### Test Sample 1234

**True Parameters:**
```
Ξ©m: 0.1074    Ξ©b: 0.8474    h: 1.0381
ns: 0.4595    Οƒ8: 0.7626    w: 1.7088
```

**MLE Result (100 iterations):**
```
Ξ©m: 0.1217    Ξ©b: 0.8408    h: 1.0709
ns: 0.3790    Οƒ8: 1.1707    w: 2.0013
```

**Likelihood Statistics:**
```
Maximum log-likelihood: -0.054964
Minimum log-likelihood: -0.061502
Range: 0.006538
```

## π“ ν•΄μ„ κ°€μ΄λ“

### Likelihood Contour μ½λ” λ²•

1. **μƒ‰μƒ**: μ§„ν• μλ΅ λ†’μ€ likelihood
2. **Peak**: κ°€μ¥ κ°€λ¥μ„± λ†’μ€ νλΌλ―Έν„° μ΅°ν•©
3. **β… (λΉ¨κ°„ λ³„)**: μ‹¤μ  νλΌλ―Έν„° κ°’
4. **β— (λ…Ήμƒ‰ μ›)**: MLEλ΅ μ°Ύμ€ κ°’
5. **β–² (λ…Έλ€ μ‚Όκ°ν•)**: Grid search maximum

### Contour λ¨μ–‘μΌλ΅ μ• μ μλ” κ²ƒ

- **μ›ν•**: νλΌλ―Έν„°λ“¤μ΄ λ…λ¦½μ 
- **νƒ€μ›/λ€κ°μ„ **: νλΌλ―Έν„° μƒκ΄€κ΄€κ³„
- **λ„“μ€ peak**: νλΌλ―Έν„° λ¶ν™•μ‹¤μ„± λ†’μ
- **μΆμ€ peak**: νλΌλ―Έν„°κ°€ μ μ μ•½λ¨
- **μ—¬λ¬ peak**: λ‹¤μ¤‘ ν•΄ μ΅΄μ¬ κ°€λ¥

## π― μ²΄ν¬λ¦¬μ¤νΈ

### Parameter Inference
- [x] Likelihood κ³„μ‚° κµ¬ν„
- [x] MLE κµ¬ν„ (gradient κΈ°λ°)
- [x] MCMC μƒν”λ§
- [x] Grid search
- [x] κ²°κ³Ό μ‹κ°ν™”
- [x] μ»¤λ§¨λ“λΌμΈ μΈν„°νμ΄μ¤
- [x] Python API
- [x] λ¬Έμ„ μ‘μ„±

### Likelihood Contour π†•
- [x] 2D grid likelihood κ³„μ‚°
- [x] Contour plot κµ¬ν„
- [x] Corner plot κµ¬ν„
- [x] True/MLE/Grid max ν‘μ‹
- [x] κ³ ν•΄μƒλ„ μ‹κ°ν™”
- [x] μ»¤λ§¨λ“λΌμΈ μΈν„°νμ΄μ¤
- [x] Python API
- [x] λ¬Έμ„ μ‘μ„±

## π’΅ μ¶”μ² μ›ν¬ν”λ΅μ°

### μƒλ΅μ΄ λ°μ΄ν„° λ¶„μ„ μ‹

```bash
# 1. λΉ λ¥Έ νƒμƒ‰ (λ‚®μ€ ν•΄μƒλ„)
python likelihood_contour.py --test_idx YOUR_IDX --corner --grid_points 10

# 2. MLEλ΅ λΉ λ¥Έ μ¶”μ •
python run_inference_example.py --test_idx YOUR_IDX --iterations 100

# 3. κ΄€μ‹¬ νλΌλ―Έν„° μ κ³ ν•΄μƒλ„ ν™•μΈ
python likelihood_contour.py --test_idx YOUR_IDX --param1 0 --param2 1 --run_mle --grid_points 30

# 4. (ν•„μ”μ‹) MCMCλ΅ posterior μ „μ²΄ νƒμƒ‰
python run_inference_example.py --test_idx YOUR_IDX --method mcmc --num_samples 2000
```

## π“ λ¬Έμ„ μ°Έμ΅°

1. **λΉ λ¥Έ μ‹μ‘**: μ΄ νμΌ
2. **Parameter Inference**: `README_INFERENCE.md`
3. **Likelihood Contour**: `LIKELIHOOD_CONTOUR_README.md`
4. **κΈ°μ  μ„Έλ¶€μ‚¬ν•­**: `PARAMETER_INFERENCE_SUMMARY.md`
5. **μ΄μ „ μ”μ•½**: `μ‘μ—…_μ™„λ£_μ”μ•½.md`

## π ν•µμ‹¬ κΈ°λ¥ μ”μ•½

| κΈ°λ¥ | μ¤ν¬λ¦½νΈ | μ£Όμ” μ©λ„ |
|------|---------|----------|
| MLE | `run_inference_example.py` | λΉ λ¥Έ νλΌλ―Έν„° μ¶”μ • |
| MCMC | `run_inference_example.py --method mcmc` | Posterior μƒν”λ§ |
| 2D Contour | `likelihood_contour.py` | Likelihood κµ¬μ΅° νμ•… |
| Corner Plot | `likelihood_contour.py --corner` | μ „μ²΄ νλΌλ―Έν„° κ³µκ°„ νƒμƒ‰ |
| MLE+Contour | `likelihood_contour.py --run_mle` | MLE κ²€μ¦ |

## π‰ μ™„μ„±!

**μ΄μ  κ΄€μΈ΅ λ°μ΄ν„° ν•λ‚λ§ μμΌλ©΄:**
1. β… νλΌλ―Έν„°λ¥Ό μ¶”μ •ν•  μ μκ³ 
2. β… Likelihood contourλ¥Ό κ·Έλ¦΄ μ μκ³ 
3. β… νλΌλ―Έν„° κ³µκ°„μ κµ¬μ΅°λ¥Ό μ‹κ°ν™”ν•  μ μκ³ 
4. β… True valueμ™€ λΉ„κµν•  μ μμµλ‹λ‹¤!

## π“ λ‹¤μ λ‹¨κ³„

μ›ν•μ‹λ©΄ μ¶”κ°€λ΅ κµ¬ν„ κ°€λ¥ν• κ²ƒλ“¤:
1. **Confidence intervals**: Likelihood contourμ—μ„ μ‹ λΆ°κµ¬κ°„ ν‘μ‹
2. **Profile likelihood**: 1D profile μλ™ κ³„μ‚°
3. **Batch inference**: μ—¬λ¬ μƒν” λ™μ‹ μ²λ¦¬
4. **Uncertainty quantification**: Posterior λ¶ν™•μ‹¤μ„± μλ™ κ³„μ‚°
5. **Interactive visualization**: Plotly κΈ°λ° μΈν„°λ™ν‹°λΈ contour

---

## π€ μ§€κΈ λ°”λ΅ μ‚¬μ©ν•κΈ°!

```bash
cd /home/work/Cosmology/FOCUS/tasks/experiment_flow

# μμ  1: MLEλ΅ νλΌλ―Έν„° μ¶”μ •
python run_inference_example.py

# μμ  2: Likelihood contour κ·Έλ¦¬κΈ°
python likelihood_contour.py --test_idx 1234 --grid_points 25

# μμ  3: MLEμ™€ contour ν•¨κ»
python likelihood_contour.py --test_idx 1234 --run_mle --grid_points 20

# μμ  4: Corner plot
python likelihood_contour.py --test_idx 1234 --corner --grid_points 15
```

**λ¨λ“  νμΌμ΄ μ¤€λΉ„λμ–΄ μμµλ‹λ‹¤!** πππ

---

**Created**: 2025-10-29  
**Status**: β… **COMPLETE**  
**Location**: `/home/work/Cosmology/FOCUS/tasks/experiment_flow/`




